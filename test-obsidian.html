<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Obsidian API 测试工具</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }
        .config-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }
        input:focus {
            outline: none;
            border-color: #007AFF;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-primary {
            background: linear-gradient(135deg, #007AFF, #5856D6);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,122,255,0.3);
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .btn-test {
            background: #28a745;
            color: white;
        }
        .btn-test:hover {
            background: #218838;
        }
        .result-section {
            margin-top: 30px;
            padding: 20px;
            border-radius: 8px;
            display: none;
        }
        .result-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .result-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .result-content {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            line-height: 1.5;
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 Obsidian API 测试工具</h1>
        
        <div class="config-section">
            <h3>📋 API 配置</h3>
            <div class="form-group">
                <label for="apiPort">API 端口:</label>
                <input type="number" id="apiPort" value="27123" placeholder="27123">
            </div>
            <div class="form-group">
                <label for="vaultName">仓库名称:</label>
                <input type="text" id="vaultName" value="ob-flomo" placeholder="ob-flomo">
            </div>
        </div>

        <div class="button-group">
            <button class="btn-test" onclick="testConnection()">🔍 测试连接</button>
            <button class="btn-primary" onclick="createTestNote()">📝 创建测试笔记</button>
            <button class="btn-secondary" onclick="testApiEndpoints()">🛠️ 测试所有端点</button>
        </div>

        <div id="result" class="result-section">
            <h4>📊 测试结果:</h4>
            <div id="resultContent" class="result-content"></div>
        </div>
    </div>

    <script>
        // 获取当前配置
        function getConfig() {
            return {
                port: document.getElementById('apiPort').value || 27123,
                vault: document.getElementById('vaultName').value || 'ob-flomo'
            };
        }

        // 显示结果
        function showResult(content, isSuccess = true) {
            const resultDiv = document.getElementById('result');
            const contentDiv = document.getElementById('resultContent');
            
            resultDiv.className = `result-section ${isSuccess ? 'result-success' : 'result-error'}`;
            contentDiv.textContent = content;
            resultDiv.style.display = 'block';
        }

        // 设置加载状态
        function setLoading(loading) {
            document.querySelector('.container').classList.toggle('loading', loading);
        }

        // 测试基础连接
        async function testConnection() {
            const config = getConfig();
            setLoading(true);
            
            try {
                const baseUrl = `http://localhost:${config.port}`;
                
                // 测试基础 API
                console.log('测试基础 API:', baseUrl);
                const response = await fetch(`${baseUrl}/`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                let result = `🔍 连接测试结果:\n\n`;
                result += `API 地址: ${baseUrl}\n`;
                result += `响应状态: ${response.status} ${response.statusText}\n`;
                
                if (response.status === 200 || response.status === 404) {
                    result += `✅ API 服务正在运行!\n\n`;
                    
                    // 测试仓库访问
                    const vaultUrl = `${baseUrl}/vault/${encodeURIComponent(config.vault)}`;
                    console.log('测试仓库访问:', vaultUrl);
                    
                    const vaultResponse = await fetch(vaultUrl, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' }
                    });
                    
                    result += `仓库测试地址: ${vaultUrl}\n`;
                    result += `仓库响应状态: ${vaultResponse.status} ${vaultResponse.statusText}\n`;
                    
                    if (vaultResponse.status === 200) {
                        result += `✅ 仓库 "${config.vault}" 存在且可访问!\n`;
                        showResult(result, true);
                    } else if (vaultResponse.status === 404) {
                        result += `❌ 仓库 "${config.vault}" 不存在或无法访问\n`;
                        result += `\n💡 建议检查:\n`;
                        result += `1. 确认 Obsidian 中的仓库名称是否为 "${config.vault}"\n`;
                        result += `2. 检查仓库名称是否拼写正确\n`;
                        result += `3. 确认 Obsidian 已打开该仓库\n`;
                        showResult(result, false);
                    } else {
                        result += `⚠️ 仓库访问异常 (${vaultResponse.status})\n`;
                        showResult(result, false);
                    }
                } else {
                    result += `❌ API 服务不可用 (${response.status})\n`;
                    result += `\n💡 请检查:\n`;
                    result += `1. Obsidian 是否正在运行\n`;
                    result += `2. Local REST API 插件是否已安装并启用\n`;
                    result += `3. 端口设置是否正确\n`;
                    showResult(result, false);
                }
                
            } catch (error) {
                const result = `❌ 连接失败: ${error.message}\n\n💡 常见原因:\n1. Obsidian 未启动\n2. Local REST API 插件未启用\n3. 端口号错误\n4. 网络连接问题`;
                showResult(result, false);
            } finally {
                setLoading(false);
            }
        }

        // 创建测试笔记
        async function createTestNote() {
            const config = getConfig();
            setLoading(true);
            
            try {
                const now = new Date();
                const timestamp = now.toISOString().replace(/[:.]/g, '-').slice(0, -5);
                const fileName = `测试笔记-${timestamp}.md`;
                
                const content = `# 🧪 API 测试笔记

**创建时间**: ${now.toLocaleString()}
**测试工具**: Obsidian API 测试工具
**API 端口**: ${config.port}
**仓库名称**: ${config.vault}

---

## 📝 测试内容

这是一条通过 Local REST API 创建的测试笔记。

### ✅ 测试项目
- [x] API 连接测试
- [x] 文件创建测试
- [x] Markdown 格式测试
- [x] 中文内容测试

### 🏷️ 标签
#测试 #API #Obsidian

---

*由 Obsidian API 测试工具创建于 ${now.toLocaleString()}*
`;

                const url = `http://localhost:${config.port}/vault/${encodeURIComponent(config.vault)}/${encodeURIComponent(fileName)}`;
                
                console.log('创建测试笔记:', url);
                console.log('文件内容:', content);
                
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'text/markdown',
                        'Accept': 'application/json'
                    },
                    body: content
                });
                
                let result = `📝 创建测试笔记结果:\n\n`;
                result += `文件名: ${fileName}\n`;
                result += `API 地址: ${url}\n`;
                result += `响应状态: ${response.status} ${response.statusText}\n`;
                
                if (response.ok) {
                    result += `✅ 测试笔记创建成功!\n`;
                    result += `\n📂 请检查 Obsidian 中是否出现了文件: ${fileName}\n`;
                    result += `\n🎉 恭喜! API 连接完全正常，可以正常使用扩展功能。`;
                    showResult(result, true);
                } else {
                    const errorText = await response.text();
                    result += `❌ 创建失败!\n`;
                    result += `错误详情: ${errorText}\n`;
                    
                    if (response.status === 404) {
                        result += `\n💡 404 错误通常表示:\n`;
                        result += `1. 仓库名称 "${config.vault}" 不存在\n`;
                        result += `2. 请检查 Obsidian 中的实际仓库名称\n`;
                        result += `3. 确保仓库名称拼写完全正确`;
                    }
                    
                    showResult(result, false);
                }
                
            } catch (error) {
                const result = `❌ 创建测试笔记失败: ${error.message}\n\n💡 请先运行"测试连接"确认 API 可用性`;
                showResult(result, false);
            } finally {
                setLoading(false);
            }
        }

        // 测试所有 API 端点
        async function testApiEndpoints() {
            const config = getConfig();
            setLoading(true);
            
            try {
                const baseUrl = `http://localhost:${config.port}`;
                let result = `🛠️ 全面 API 测试结果:\n\n`;
                
                // 测试端点列表
                const endpoints = [
                    { name: '根路径', url: '/' },
                    { name: '仓库根目录', url: `/vault/${encodeURIComponent(config.vault)}` },
                    { name: '仓库信息', url: `/vault` }
                ];
                
                for (const endpoint of endpoints) {
                    try {
                        const url = `${baseUrl}${endpoint.url}`;
                        const response = await fetch(url, {
                            method: 'GET',
                            headers: { 'Accept': 'application/json' }
                        });
                        
                        result += `📍 ${endpoint.name}:\n`;
                        result += `   URL: ${url}\n`;
                        result += `   状态: ${response.status} ${response.statusText}\n`;
                        
                        if (response.status === 200) {
                            result += `   ✅ 正常\n`;
                        } else if (response.status === 404) {
                            result += `   ⚠️ 未找到 (可能正常)\n`;
                        } else {
                            result += `   ❌ 异常\n`;
                        }
                        result += `\n`;
                        
                    } catch (error) {
                        result += `📍 ${endpoint.name}: ❌ 连接失败 (${error.message})\n\n`;
                    }
                }
                
                result += `\n📋 测试总结:\n`;
                result += `- API 端口: ${config.port}\n`;
                result += `- 仓库名称: ${config.vault}\n`;
                result += `- 测试时间: ${new Date().toLocaleString()}\n`;
                
                showResult(result, true);
                
            } catch (error) {
                showResult(`❌ 测试失败: ${error.message}`, false);
            } finally {
                setLoading(false);
            }
        }

        // 页面加载完成后自动运行基础测试
        window.addEventListener('load', () => {
            console.log('🔧 Obsidian API 测试工具已加载');
            console.log('当前配置:', getConfig());
        });
    </script>
</body>
</html> 